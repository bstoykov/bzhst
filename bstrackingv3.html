<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä 3x2 | –•–∏–±—Ä–∏–¥–µ–Ω –º–æ–¥–µ–ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .quick-add {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .quick-add h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .date-input {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            min-width: 200px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
        }

        .btn-office {
            background: #4CAF50;
            color: white;
        }

        .btn-office:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-home {
            background: #2196F3;
            color: white;
        }

        .btn-home:hover {
            background: #0b7dda;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-vacation {
            background: #FF9800;
            color: white;
        }

        .btn-vacation:hover {
            background: #e68900;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-holiday {
            background: #9C27B0;
            color: white;
        }

        .btn-holiday:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid white;
            font-size: 1.1em;
            padding: 12px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            max-width: 600px;
            max-height: 85vh;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
        }

        .close-btn {
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            line-height: 1;
            transition: transform 0.2s;
        }

        .close-btn:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
            line-height: 1.8;
            overflow-y: auto;
            flex: 1;
        }

        .info-section {
            margin-bottom: 25px;
        }

        .info-section h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section p {
            margin: 8px 0;
            color: #555;
        }

        .info-highlight {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 10% 20px;
                max-width: none;
            }

            .modal-body {
                padding: 20px;
            }
        }

        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
        }

        .auth-box h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-btn-primary {
            background: #667eea;
            color: white;
        }

        .auth-btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .auth-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .auth-btn-secondary:hover {
            background: #d0d0d0;
        }

        .auth-link {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-link a {
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-link a:hover {
            text-decoration: underline;
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .mode-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border: 3px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .mode-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .mode-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .mode-card p {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .mode-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .status-local {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-cloud {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        @media (max-width: 768px) {
            .mode-selection {
                grid-template-columns: 1fr;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease, background 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .status-good {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .calendar {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .calendar h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e0e0e0;
        }

        .calendar-day:hover {
            transform: scale(1.05);
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .day-office {
            background: #c8e6c9;
            border-color: #4CAF50;
        }

        .day-home {
            background: #bbdefb;
            border-color: #2196F3;
        }

        .day-home-auto {
            background: #e3f2fd;
            border-color: #90caf9;
            border-style: dashed;
        }

        .day-vacation {
            background: #ffe0b2;
            border-color: #FF9800;
        }

        .day-holiday {
            background: #e1bee7;
            border-color: #9C27B0;
        }

        .day-weekend {
            background: #f5f5f5;
            color: #999;
        }

        .day-header {
            font-weight: bold;
            color: #667eea;
            padding: 10px;
            text-align: center;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .period-btn:hover {
            transform: translateY(-2px);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: bold;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .calendar-grid {
                gap: 5px;
            }

            .calendar-day {
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üè¢ –û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä 3x2
                <span id="cloudStatusBadge" style="display: none; font-size: 0.4em; vertical-align: middle; background: #e3f2fd; color: #1976d2; padding: 8px 16px; border-radius: 20px; margin-left: 15px;">
                    ‚òÅÔ∏è <span id="cloudStatusEmail"></span>
                </span>
            </h1>
            <p>–ü—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ –Ω–∞ —Ö–∏–±—Ä–∏–¥–Ω–∏—è —Ä–∞–±–æ—Ç–µ–Ω –º–æ–¥–µ–ª</p>
            <p style="margin-top: 10px; color: #667eea; font-weight: 600; font-size: 0.95em;">Created by Bozhidar Stoykov</p>
            <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn-info" onclick="openInfoModal()">
                    ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –Ø–∫ —Ä–∞–±–æ—Ç–∏?
                </button>
                <button class="btn-info" onclick="openLocalModal()">
                    üíæ –õ–æ–∫–∞–ª–Ω–æ
                </button>
                <button class="btn-info" onclick="openCloudModal()">
                    ‚òÅÔ∏è –û–±–ª–∞–∫
                </button>
            </div>
        </div>

        <div class="quick-add">
            <h2>üìÖ –î–æ–±–∞–≤–∏ –¥–µ–Ω</h2>
            <div class="date-input">
                <input type="date" id="dateInput">
            </div>
            <div class="button-group">
                <button class="btn btn-office" onclick="addDay('office')">üè¢ –û—Ñ–∏—Å</button>
                <button class="btn btn-home" onclick="addDay('home')">üè† Home Office</button>
                <button class="btn btn-vacation" onclick="addDay('vacation')">üå¥ –ü–æ—á–∏–≤–∫–∞/–ë–æ–ª–Ω–∏—á–µ–Ω</button>
                <button class="btn btn-holiday" onclick="addDay('holiday')">üéâ –ü—Ä–∞–∑–Ω–∏–∫</button>
            </div>
        </div>

        <div class="period-selector">
            <button class="period-btn active" onclick="changePeriod('week')">–°–µ–¥–º–∏—Ü–∞</button>
            <button class="period-btn" onclick="changePeriod('month')">–ú–µ—Å–µ—Ü</button>
            <button class="period-btn" onclick="changePeriod('quarter')">–¢—Ä–∏–º–µ—Å–µ—á–∏–µ (Q1/Q2/Q3/Q4)</button>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be inserted here -->
        </div>

        <div class="calendar">
            <h2 id="calendarTitle">–ö–∞–ª–µ–Ω–¥–∞—Ä</h2>
            <div class="calendar-grid" id="calendarGrid">
                <!-- Calendar will be inserted here -->
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color day-office"></div>
                    <span>–û—Ñ–∏—Å</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color day-home"></div>
                    <span>Home Office (–º–∞—Ä–∫–∏—Ä–∞–Ω)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color day-home-auto"></div>
                    <span>Home Office (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color day-vacation"></div>
                    <span>–ü–æ—á–∏–≤–∫–∞/–ë–æ–ª–Ω–∏—á–µ–Ω</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color day-holiday"></div>
                    <span>–ü—Ä–∞–∑–Ω–∏–∫</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color day-weekend"></div>
                    <span>–ü–æ—á–∏–≤–µ–Ω –¥–µ–Ω (—É–∏–∫–µ–Ω–¥)</span>
                </div>
            </div>
        </div>

        <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px; border-radius: 15px; text-align: center; margin-top: 30px; color: white;">
            <p style="margin: 0; font-size: 0.9em;">
                <strong>–û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä 3x2</strong> | –°—ä–∑–¥–∞–¥–µ–Ω–æ –æ—Ç <strong>Bozhidar Stoykov</strong>
            </p>
            <p style="margin: 5px 0 0 0; font-size: 0.8em; opacity: 0.8;">
                v1.0 | –§–µ–≤—Ä—É–∞—Ä–∏ 2026 | –î–∞–Ω–Ω–∏—Ç–µ —Å–µ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞—Ç –ª–æ–∫–∞–ª–Ω–æ –≤—ä–≤ –≤–∞—à–∏—è –±—Ä–∞—É–∑—ä—Ä
            </p>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∏ –û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä—ä—Ç?</h2>
                <button class="close-btn" onclick="closeInfoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h3>üè¢ –û—Ñ–∏—Å –±—É—Ç–æ–Ω</h3>
                    <p>–ú–∞—Ä–∫–∏—Ä–∞–π –¥–Ω–∏—Ç–µ –∫–æ–≥–∞—Ç–æ —Å–∏ –±–∏–ª —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –≤ –æ—Ñ–∏—Å–∞. –¢–µ–∑–∏ –¥–Ω–∏ —Å–µ –±—Ä–æ—è—Ç –∫—ä–º –∫–æ–º–ø–ª–∞–π—ä–Ω—Å —Ü–µ–ª—Ç–∞ –æ—Ç 60%.</p>
                </div>

                <div class="info-section">
                    <h3>üè† Home Office –±—É—Ç–æ–Ω</h3>
                    <p><strong>–ú–æ–∂–µ—à –¥–∞ –º–∞—Ä–∫–∏—Ä–∞—à –∏–∑—Ä–∏—á–Ω–æ</strong> –∏–ª–∏ –¥–∞ –æ—Å—Ç–∞–≤–∏—à –ø—Ä–∞–∑–Ω–æ - –º–∏–Ω–∞–ª–∏ —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏ –±–µ–∑ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ –±—Ä–æ—è—Ç –∫–∞—Ç–æ Home Office.</p>
                    <p style="font-size: 0.9em; color: #666;">‚Ä¢ –ú–∞—Ä–∫–∏—Ä–∞–Ω–∏ home office –¥–Ω–∏ ‚Üí —Ç—ä–º–Ω–æ —Å–∏–Ω—å–æ —Å üè†</p>
                    <p style="font-size: 0.9em; color: #666;">‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ home office ‚Üí —Å–≤–µ—Ç–ª–æ —Å–∏–Ω—å–æ —Å üì±</p>
                </div>

                <div class="info-section">
                    <h3>üå¥ –ü–æ—á–∏–≤–∫–∞/–ë–æ–ª–Ω–∏—á–µ–Ω –±—É—Ç–æ–Ω</h3>
                    <p>–ú–∞—Ä–∫–∏—Ä–∞–π –æ—Ç–ø—É—Å–∫–∏, –±–æ–ª–Ω–∏—á–Ω–∏ –∏ –ø—Ä–∞–∑–Ω–∏—Ü–∏. –¢–µ–∑–∏ –¥–Ω–∏ —Å–µ <strong>–ø—Ä–∏—Å–ø–∞–¥–∞—Ç</strong> –æ—Ç –æ–±—â–∏—Ç–µ —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏ –∏ –ù–ï –≤–ª–∏—è—è—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –Ω–∞ –∫–æ–º–ø–ª–∞–π—ä–Ω—Å–∞.</p>
                </div>

                <div class="info-section">
                    <h3>üéâ –ü—Ä–∞–∑–Ω–∏–∫ –±—É—Ç–æ–Ω</h3>
                    <p>–ó–∞ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏ –ø—Ä–∞–∑–Ω–∏—Ü–∏ (1 —è–Ω—É–∞—Ä–∏, 3 –º–∞—Ä—Ç –∏ —Ç.–Ω.). –ü—Ä–∏—Å–ø–∞–¥–∞—Ç —Å–µ –æ—Ç –∫–æ–º–ø–ª–∞–π—ä–Ω—Å –∏–∑—á–∏—Å–ª–µ–Ω–∏–µ—Ç–æ.</p>
                </div>

                <div class="info-highlight">
                    <h3>üéØ –ö–æ–º–ø–ª–∞–π—ä–Ω—Å —Ü–µ–ª: 60%</h3>
                    <p><strong>–ö–∞–∫ —Å–µ –∏–∑—á–∏—Å–ª—è–≤–∞:</strong></p>
                    <p>–û–±—â–æ —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏ - –ü–æ—á–∏–≤–∫–∏ - –ü—Ä–∞–∑–Ω–∏—Ü–∏ = –ù–∞–ª–∏—á–Ω–∏ –¥–Ω–∏</p>
                    <p>–ù–∞–ª–∏—á–Ω–∏ –¥–Ω–∏ √ó 60% = –ù–µ–æ–±—Ö–æ–¥–∏–º–∏ –æ—Ñ–∏—Å –¥–Ω–∏</p>
                    <p><em>–ü—Ä–∏–º–µ—Ä: 60 —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏ - 5 –ø–æ—á–∏–≤–∫–∏ = 55 –¥–Ω–∏ ‚Üí –ù—É–∂–Ω–∏ 33 –æ—Ñ–∏—Å –¥–Ω–∏ (60%)</em></p>
                </div>

                <div class="info-section">
                    <h3>üìä –ü–µ—Ä–∏–æ–¥–∏ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ</h3>
                    <p><strong>–°–µ–¥–º–∏—Ü–∞</strong> - —Ç–µ–∫—É—â–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ (–ü–Ω-–ù–¥)</p>
                    <p><strong>–ú–µ—Å–µ—Ü</strong> - —Ç–µ–∫—É—â–∏—è—Ç –º–µ—Å–µ—Ü (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–µ —Å–º–µ–Ω—è)</p>
                    <p><strong>–¢—Ä–∏–º–µ—Å–µ—á–∏–µ</strong> - Q1 (–Ø–Ω-–ú–∞—Ä), Q2 (–ê–ø—Ä-–Æ–Ω–∏), Q3 (–Æ–ª–∏-–°–µ–ø), Q4 (–û–∫—Ç-–î–µ–∫)</p>
                </div>

                <div class="info-section">
                    <h3>üíæ –õ–æ–∫–∞–ª–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ</h3>
                    <p>–î–∞–Ω–Ω–∏—Ç–µ —Å–µ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞—Ç <strong>–ª–æ–∫–∞–ª–Ω–æ –≤ –±—Ä–∞—É–∑—ä—Ä–∞</strong> –Ω–∞ —Ç–æ–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.</p>
                    <p><strong>‚úÖ –ü–ª—é—Å–æ–≤–µ:</strong></p>
                    <p style="margin-left: 20px;">‚Ä¢ –†–∞–±–æ—Ç–∏ –æ—Ñ–ª–∞–π–Ω<br>‚Ä¢ –ë–µ–∑ –Ω—É–∂–¥–∞ –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è<br>‚Ä¢ –ü—ä–ª–Ω–∞ –ø–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</p>
                    <p><strong>‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</strong></p>
                    <p style="margin-left: 20px;">‚Ä¢ –í—Å—è–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–∞ –æ—Ç–¥–µ–ª–Ω–∏ –¥–∞–Ω–Ω–∏<br>‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω –∏ –∫–æ–º–ø—é—Ç—ä—Ä - —Ä–∞–∑–ª–∏—á–Ω–∏ –∑–∞–ø–∏—Å–∏<br>‚Ä¢ –†—ä—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –æ—Ç—á–µ—Ç–∏</p>
                </div>

                <div class="info-section">
                    <h3>‚òÅÔ∏è –û–±–ª–∞—á–µ–Ω —Ä–µ–∂–∏–º</h3>
                    <p>–î–∞–Ω–Ω–∏—Ç–µ —Å–µ —Å—ä—Ö—Ä–∞–Ω—è–≤–∞—Ç <strong>–≤ –æ–±–ª–∞–∫–∞</strong> –∏ —Å–∞ –¥–æ—Å—Ç—ä–ø–Ω–∏ –æ—Ç –≤—Å–∏—á–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
                    <p><strong>‚úÖ –ü–ª—é—Å–æ–≤–µ:</strong></p>
                    <p style="margin-left: 20px;">‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞<br>‚Ä¢ –î–æ—Å—Ç—ä–ø –æ—Ç –∫–æ–º–ø—é—Ç—ä—Ä –ò —Ç–µ–ª–µ—Ñ–æ–Ω<br>‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ email –æ—Ç—á–µ—Ç–∏<br>‚Ä¢ Scheduled –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –≤—Å–µ–∫–∏ 4 –¥–Ω–∏<br>‚Ä¢ –ò–∑–ø—Ä–∞—â–∞–Ω–µ –¥–æ –º–µ–Ω–∏–¥–∂—ä—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</p>
                    <p><strong>‚ÑπÔ∏è –ó–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ:</strong></p>
                    <p style="margin-left: 20px;">‚Ä¢ –ò–∑–∏—Å–∫–≤–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è<br>‚Ä¢ –ù–∞—Ç–∏—Å–Ω–∏ "‚òÅÔ∏è –û–±–ª–∞–∫" ‚Üí "–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ"</p>
                </div>

                <div class="info-section">
                    <h3>üé® –¶–≤–µ—Ç–æ–≤–∞ –ª–µ–≥–µ–Ω–¥–∞</h3>
                    <p>üü¢ –ó–µ–ª–µ–Ω–æ - –û—Ñ–∏—Å | üîµ –°–∏–Ω—å–æ - Home Office (–º–∞—Ä–∫–∏—Ä–∞–Ω)</p>
                    <p>üî∑ –°–≤–µ—Ç–ª–æ —Å–∏–Ω—å–æ - Home Office (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ) | üü† –û—Ä–∞–Ω–∂–µ–≤–æ - –ü–æ—á–∏–≤–∫–∞</p>
                    <p>üü£ –õ–∏–ª–∞–≤–æ - –ü—Ä–∞–∑–Ω–∏–∫ | ‚ö™ –°–∏–≤–æ - –£–∏–∫–µ–Ω–¥</p>
                </div>

                <div class="info-highlight" style="background: #d4edda; border-color: #4CAF50;">
                    <p style="margin: 0; font-weight: bold; color: #155724;">üí° –°—ä–≤–µ—Ç: –ú–∞—Ä–∫–∏—Ä–∞–π —Å–∞–º–æ –æ—Ñ–∏—Å –¥–Ω–∏—Ç–µ –∏ –ø–æ—á–∏–≤–∫–∏—Ç–µ - –æ—Å—Ç–∞–Ω–∞–ª–æ—Ç–æ —Å–µ –±—Ä–æ–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–∞—Ç–æ home office!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Local Storage Modal -->
    <div id="localModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíæ –õ–æ–∫–∞–ª–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ</h2>
                <button class="close-btn" onclick="closeLocalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h3>üì• –ò–º–ø–æ—Ä—Ç/–ï–∫—Å–ø–æ—Ä—Ç</h3>
                    
                    <button onclick="exportJSON()" style="width: 100%; padding: 15px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üì• –ò–∑—Ç–µ–≥–ª–∏ JSON —Ñ–∞–π–ª
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0 20px 0;">–ó–∞ backup –∏ –ø—Ä–µ—Ö–≤—ä—Ä–ª—è–Ω–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</p>
                    
                    <button onclick="exportCSV()" style="width: 100%; padding: 15px; margin: 10px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üìä –ò–∑—Ç–µ–≥–ª–∏ CSV —Ñ–∞–π–ª
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0 20px 0;">–ó–∞ –ø—Ä–µ–≥–ª–µ–¥ –∏ —Ä–µ–¥–∞–∫—Ü–∏—è –≤ Excel</p>
                    
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importJSON(event)">
                    <button onclick="document.getElementById('importFileInput').click()" style="width: 100%; padding: 15px; margin: 10px 0; background: #FF9800; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üì§ –ö–∞—á–∏ JSON —Ñ–∞–π–ª
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">–í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ –¥–∞–Ω–Ω–∏ –æ—Ç backup —Ñ–∞–π–ª</p>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">

                <div class="info-section">
                    <h3>üìß –ò–∑–ø—Ä–∞—Ç–∏ —Ä—ä—á–Ω–æ</h3>
                    
                    <button onclick="shareViaEmail()" style="width: 100%; padding: 15px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üìß –ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ Email
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0 20px 0;">–û—Ç–≤–∞—Ä—è email –∫–ª–∏–µ–Ω—Ç —Å –≥–æ—Ç–æ–≤ –æ—Ç—á–µ—Ç</p>
                    
                    <button onclick="shareViaTelegram()" style="width: 100%; padding: 15px; margin: 10px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üì± –°–ø–æ–¥–µ–ª–∏ –≤ Telegram
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0 20px 0;">–û—Ç–≤–∞—Ä—è Telegram —Å –≥–æ—Ç–æ–≤ –æ—Ç—á–µ—Ç</p>
                    
                    <button onclick="copyReport()" style="width: 100%; padding: 15px; margin: 10px 0; background: #FF9800; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üìã –ö–æ–ø–∏—Ä–∞–π —Ç–µ–∫—Å—Ç
                    </button>
                    <p style="font-size: 0.9em; color: #666; margin: 5px 0;">–ö–æ–ø–∏—Ä–∞ –æ—Ç—á–µ—Ç–∞ –≤ clipboard</p>
                </div>

                <div class="info-highlight" style="background: #e3f2fd; border-color: #2196F3; margin-top: 30px;">
                    <p style="margin: 0; font-size: 0.95em; color: #0d47a1;">
                        <strong>üí° –ö–∞–∫ –¥–∞ –ø—Ä–µ—Ö–≤—ä—Ä–ª–∏—à –¥–∞–Ω–Ω–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</strong><br>
                        1Ô∏è‚É£ –ò–∑—Ç–µ–≥–ª–∏ JSON —Ñ–∞–π–ª<br>
                        2Ô∏è‚É£ –ò–∑–ø—Ä–∞—Ç–∏ –≥–æ –Ω–∞ —Å–µ–±–µ —Å–∏ (email, Telegram)<br>
                        3Ô∏è‚É£ –û—Ç–≤–æ—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ—Ç–æ –Ω–∞ –¥—Ä—É–≥–æ—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ<br>
                        4Ô∏è‚É£ –ö–∞—á–∏ JSON —Ñ–∞–π–ª–∞ ‚Üí –ì–æ—Ç–æ–≤–æ! üéâ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cloud Modal -->
    <div id="cloudModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚òÅÔ∏è –û–±–ª–∞—á–µ–Ω —Ä–µ–∂–∏–º</h2>
                <button class="close-btn" onclick="closeCloudModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Not Logged In View -->
                <div id="cloudNotLoggedIn">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üîê</div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
                        <p style="color: #666; margin-bottom: 30px;">
                            –í–ª–µ–∑ –∏–ª–∏ —Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π –∑–∞ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞—à –æ–±–ª–∞—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ emails
                        </p>
                        
                        <button onclick="showCloudLogin()" style="width: 100%; padding: 15px; margin: 10px 0; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            üîì –í–ª–µ–∑
                        </button>
                        
                        <button onclick="showCloudRegister()" style="width: 100%; padding: 15px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ
                        </button>
                    </div>
                </div>

                <!-- Logged In View -->
                <div id="cloudLoggedIn" class="hidden">
                    <div class="info-section">
                        <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <p style="margin: 0;"><strong>üë§ –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:</strong> <span id="cloudUserEmail"></span></p>
                        </div>
                        
                        <h3>üìß –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –æ—Ç—á–µ—Ç–∏</h3>
                        
                        <button onclick="sendToMyEmail()" style="width: 100%; padding: 15px; margin: 10px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            üìß –ò–∑–ø—Ä–∞—Ç–∏ –Ω–∞ –º–æ—è email
                        </button>
                        <p style="font-size: 0.9em; color: #666; margin: 5px 0 20px 0;">–ò–∑–ø—Ä–∞—Ç–∏ –æ—Ç—á–µ—Ç –Ω–∞ <span id="cloudUserEmailShort"></span></p>
                        
                        <button onclick="showSendToOthers()" style="width: 100%; padding: 15px; margin: 10px 0; background: #2196F3; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                            üìß –ò–∑–ø—Ä–∞—Ç–∏ –¥–æ –¥—Ä—É–≥/–¥—Ä—É–≥–∏
                        </button>
                        <p style="font-size: 0.9em; color: #666; margin: 5px 0;">–í—ä–≤–µ–¥–∏ email –∞–¥—Ä–µ—Å–∏ –Ω–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏</p>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">

                    <div class="info-section">
                        <h3>‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ</h3>
                        
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin: 10px 0;">
                            <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 10px;">
                                <input type="checkbox" id="autoSendToMe" onchange="toggleAutoSend('me')" style="margin-right: 10px; width: 20px; height: 20px;">
                                <span>–ù–∞ –º–æ—è email –Ω–∞ –≤—Å–µ–∫–∏ 4 –¥–Ω–∏</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="autoSendToManager" onchange="toggleAutoSend('manager')" style="margin-right: 10px; width: 20px; height: 20px;">
                                <span>–î–æ –º–µ–Ω–∏–¥–∂—ä—Ä–∞ (<span id="managerEmail">–Ω–µ –µ –∑–∞–¥–∞–¥–µ–Ω</span>)</span>
                            </label>
                        </div>
                        
                        <button onclick="setManagerEmail()" style="width: 100%; padding: 12px; margin: 10px 0; background: #e0e0e0; color: #333; border: none; border-radius: 10px; font-size: 1em; cursor: pointer; font-weight: bold;">
                            ‚úèÔ∏è –ó–∞–¥–∞–π email –Ω–∞ –º–µ–Ω–∏–¥–∂—ä—Ä
                        </button>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">

                    <button onclick="cloudLogout()" style="width: 100%; padding: 15px; margin: 10px 0; background: #f44336; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üö™ –ò–∑—Ö–æ–¥
                    </button>
                </div>

                <!-- Send to Others Form -->
                <div id="sendToOthersForm" class="hidden">
                    <button onclick="backToCloudMain()" style="padding: 10px 20px; margin-bottom: 20px; background: #e0e0e0; border: none; border-radius: 8px; cursor: pointer;">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    
                    <h3>üìß –ò–∑–ø—Ä–∞—Ç–∏ –¥–æ –¥—Ä—É–≥/–¥—Ä—É–≥–∏</h3>
                    
                    <p style="color: #666; margin: 15px 0;">–í—ä–≤–µ–¥–∏ email –∞–¥—Ä–µ—Å–∏, —Ä–∞–∑–¥–µ–ª–µ–Ω–∏ —Å—ä—Å –∑–∞–ø–µ—Ç–∞—è:</p>
                    
                    <textarea id="otherEmails" style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; min-height: 100px; font-family: inherit;" placeholder="manager@company.com, hr@company.com"></textarea>
                    
                    <button onclick="sendToOtherEmails()" style="width: 100%; padding: 15px; margin: 20px 0 10px 0; background: #4CAF50; color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; font-weight: bold;">
                        üìß –ò–∑–ø—Ä–∞—Ç–∏ –æ—Ç—á–µ—Ç
                    </button>
                </div>
            </div>
        </div>
    </div>

<!-- Login Modal -->
<div id="loginModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>üîì –í—Ö–æ–¥</h2>
            <button class="close-btn" onclick="closeLoginModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="email" id="loginEmailInput" class="auth-input" placeholder="üìß Email" />
            <input type="password" id="loginPasswordInput" class="auth-input" placeholder="üîí –ü–∞—Ä–æ–ª–∞" />
            
            <button onclick="doLogin()" class="auth-btn auth-btn-primary">
                üîì –í–ª–µ–∑
            </button>
            
            <div class="auth-link">
                –ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? <a onclick="switchToRegister()">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</a>
            </div>
        </div>
    </div>
</div>

<!-- Register Modal -->
<div id="registerModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <button class="close-btn" onclick="closeRegisterModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="text" id="registerNameInput" class="auth-input" placeholder="üë§ –ò–º–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)" />
            <input type="email" id="registerEmailInput" class="auth-input" placeholder="üìß Email" />
            <input type="password" id="registerPasswordInput" class="auth-input" placeholder="üîí –ü–∞—Ä–æ–ª–∞" />
            <input type="password" id="registerPasswordConfirmInput" class="auth-input" placeholder="üîí –ü–æ—Ç–≤—ä—Ä–¥–∏ –ø–∞—Ä–æ–ª–∞" />
            
            <button onclick="doRegister()" class="auth-btn auth-btn-primary">
                üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ
            </button>
            
            <div class="auth-link">
                –í–µ—á–µ –∏–º–∞—à –∞–∫–∞—É–Ω—Ç? <a onclick="switchToLogin()">–í–ª–µ–∑ —Ç—É–∫</a>
            </div>
        </div>
    </div>
</div>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx252XQazRiC3T9OGkHc8vJPRQKrXUk2xmQMMwZdDwTwL4RGSKrJea1O7FZD85CQepfTQ/exec';
        
        // ============================================
        // GLOBAL STATE
        // ============================================
        let cloudUser = JSON.parse(localStorage.getItem('cloudUser')) || null;
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let currentPeriod = 'quarter';

        // ============================================
        // INITIALIZATION
        // ============================================
        // Set today's date in input
        document.getElementById('dateInput').valueAsDate = new Date();
        
        // Check if migration is needed or load cloud data
        checkMigrationNeeded();
        
        updateCloudStatusBadge();

        // ============================================
        // CLOUD DATA SYNC
        // ============================================
        function loadCloudData() {
            console.log('[LOAD FROM CLOUD] Starting...');
            const callbackName = 'loadCallback_' + Date.now();
            
            window[callbackName] = function(result) {
                console.log('[LOAD FROM CLOUD] Response:', result);
                document.getElementById(callbackName + '_script').remove();
                delete window[callbackName];
                
                if (result.success && result.data) {
                    console.log('[LOAD FROM CLOUD] Data received:', Object.keys(result.data).length, 'records');
                    console.log('[LOAD FROM CLOUD] Data:', result.data);
                    
                    // Merge cloud data with local data
                    attendanceData = result.data;
                    localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    updateDisplay();
                } else {
                    console.error('[LOAD FROM CLOUD] No data or error:', result);
                    // No cloud data or error, use local data
                    updateDisplay();
                }
            };
            
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=loadAttendance&email=${encodeURIComponent(cloudUser.email)}&callback=${callbackName}`;
            console.log('[LOAD FROM CLOUD] URL:', url);
            
            const script = document.createElement('script');
            script.id = callbackName + '_script';
            script.src = url;
            script.onerror = function() {
                console.error('[LOAD FROM CLOUD] Script load failed');
                document.getElementById(callbackName + '_script').remove();
                delete window[callbackName];
                updateDisplay();
            };
            document.body.appendChild(script);
        }

        function saveToCloud(date, type) {
            if (!cloudUser || !cloudUser.email) return Promise.reject('No cloud user');
            
            console.log(`[SAVE TO CLOUD] ${date} = ${type}`);
            
            // Return promise so we can wait for it
            return fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveAttendance',
                    email: cloudUser.email,
                    date: date,
                    type: type
                })
            })
            .then(() => {
                console.log(`[SAVE SUCCESS] ${date}`);
            })
            .catch(error => {
                console.error(`[SAVE ERROR] ${date}:`, error);
                throw error;
            });
        }

        function migrateLocalToCloud() {
            if (!cloudUser || !cloudUser.email) return;
            
            const localData = attendanceData;
            const dates = Object.keys(localData);
            
            if (dates.length === 0) return;
            
            console.log(`[MIGRATE LOCAL TO CLOUD] Starting migration of ${dates.length} records...`);
            
            // Upload all local data to cloud
            const savePromises = dates.map(date => {
                const type = localData[date];
                return saveToCloud(date, type);
            });
            
            // Wait for all saves
            Promise.all(savePromises)
                .then(() => {
                    console.log('[MIGRATE LOCAL TO CLOUD] All saves completed!');
                    // Mark as migrated
                    localStorage.setItem('hasLoadedCloudData_' + cloudUser.email, 'true');
                    
                    // Wait extra 3 seconds for Google Sheets to process, then reload
                    setTimeout(() => {
                        console.log('[MIGRATE LOCAL TO CLOUD] Loading from cloud...');
                        loadCloudData();
                        alert(`‚úÖ ${dates.length} –∑–∞–ø–∏—Å–∞ —Å–∞ –∫–∞—á–µ–Ω–∏ –≤ –æ–±–ª–∞–∫–∞!`);
                    }, 3000);
                })
                .catch(error => {
                    console.error('[MIGRATE LOCAL TO CLOUD ERROR]', error);
                    alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏—è! –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.');
                });
        }

        function checkMigrationNeeded() {
            if (!cloudUser || !cloudUser.email) {
                updateDisplay();
                return;
            }
            
            const localDataCount = Object.keys(attendanceData).length;
            const hasLoadedCloudData = localStorage.getItem('hasLoadedCloudData_' + cloudUser.email);
            
            if (!hasLoadedCloudData && localDataCount > 0) {
                // First time loading with local data - offer migration
                const migrate = confirm(
                    `üíæ ‚Üí ‚òÅÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è –∫—ä–º –æ–±–ª–∞–∫\n\n` +
                    `–ù–∞–º–µ—Ä–µ–Ω–∏ ${localDataCount} –ª–æ–∫–∞–ª–Ω–∏ –∑–∞–ø–∏—Å–∞.\n\n` +
                    `–ò—Å–∫–∞—à –ª–∏ –¥–∞ –≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—à —Å –æ–±–ª–∞–∫–∞?\n\n` +
                    `OK = –î–∞, –∫–∞—á–∏ –≥–∏\n` +
                    `Cancel = –ù–µ, –∏–∑–ø–æ–ª–∑–≤–∞–π —Å–∞–º–æ –æ–±–ª–∞—á–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏`
                );
                
                if (migrate) {
                    migrateLocalToCloud();
                } else {
                    localStorage.setItem('hasLoadedCloudData_' + cloudUser.email, 'true');
                    attendanceData = {};
                    localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    loadCloudData();
                }
            } else {
                // Already migrated or no local data - just load cloud
                loadCloudData();
            }
        }

        // ============================================
        // CLOUD STATUS BADGE
        // ============================================
        function maskEmail(email) {
            if (!email) return '';
            const parts = email.split('@');
            if (parts.length !== 2) return email;
            
            const username = parts[0];
            const domain = parts[1];
            
            if (username.length <= 2) {
                return email; // Too short to mask
            }
            
            const first = username[0];
            const last = username[username.length - 1];
            const masked = first + '***' + last + '@' + domain;
            
            return masked;
        }

        function updateCloudStatusBadge() {
            const badge = document.getElementById('cloudStatusBadge');
            const emailSpan = document.getElementById('cloudStatusEmail');
            
            if (cloudUser && cloudUser.email) {
                badge.style.display = 'inline-block';
                emailSpan.textContent = maskEmail(cloudUser.email);
            } else {
                badge.style.display = 'none';
            }
        }

        // ============================================
        // MODAL CONTROLS
        // ============================================
        function openLocalModal() {
            document.getElementById('localModal').style.display = 'block';
        }

        function closeLocalModal() {
            document.getElementById('localModal').style.display = 'none';
        }

        function openCloudModal() {
            document.getElementById('cloudModal').style.display = 'block';
            updateCloudModalView();
        }

        function closeCloudModal() {
            document.getElementById('cloudModal').style.display = 'none';
            // Reset to main view
            document.getElementById('cloudNotLoggedIn').classList.remove('hidden');
            document.getElementById('cloudLoggedIn').classList.add('hidden');
            document.getElementById('sendToOthersForm').classList.add('hidden');
        }

        function updateCloudModalView() {
            if (cloudUser) {
                document.getElementById('cloudNotLoggedIn').classList.add('hidden');
                document.getElementById('cloudLoggedIn').classList.remove('hidden');
                document.getElementById('cloudUserEmail').textContent = cloudUser.email;
                document.getElementById('cloudUserEmailShort').textContent = cloudUser.email;
                document.getElementById('autoSendToMe').checked = cloudUser.autoSendToMe || false;
                document.getElementById('autoSendToManager').checked = cloudUser.autoSendToManager || false;
                document.getElementById('managerEmail').textContent = cloudUser.managerEmail || '–Ω–µ –µ –∑–∞–¥–∞–¥–µ–Ω';
            } else {
                document.getElementById('cloudNotLoggedIn').classList.remove('hidden');
                document.getElementById('cloudLoggedIn').classList.add('hidden');
            }
        }

        // ============================================
        // CLOUD AUTH (SIMPLIFIED)
        // ============================================
        function showCloudLogin() {
            closeCloudModal();
            document.getElementById('loginModal').style.display = 'block';
        }

        function showCloudRegister() {
            closeCloudModal();
            document.getElementById('registerModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginEmailInput').value = '';
            document.getElementById('loginPasswordInput').value = '';
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('registerNameInput').value = '';
            document.getElementById('registerEmailInput').value = '';
            document.getElementById('registerPasswordInput').value = '';
            document.getElementById('registerPasswordConfirmInput').value = '';
        }

        function switchToRegister() {
            closeLoginModal();
            showCloudRegister();
        }

        function switchToLogin() {
            closeRegisterModal();
            showCloudLogin();
        }

        function doLogin() {
            const email = document.getElementById('loginEmailInput').value.trim();
            const password = document.getElementById('loginPasswordInput').value;
            
            if (!email || !password) {
                alert('‚ùå –ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–µ—Ç–µ email –∏ –ø–∞—Ä–æ–ª–∞!');
                return;
            }
            
            // Use JSONP to get real response from Apps Script
            const callbackName = 'loginCallback_' + Date.now();
            
            window[callbackName] = function(result) {
                document.getElementById(callbackName + '_script').remove();
                delete window[callbackName];
                
                if (result.success) {
                    cloudUser = {
                        email: email,
                        name: result.user.name || email.split('@')[0],
                        autoSendToMe: result.user.autoSendToMe || false,
                        autoSendToManager: result.user.autoSendToManager || false,
                        managerEmail: result.user.managerEmail || null
                    };
                    localStorage.setItem('cloudUser', JSON.stringify(cloudUser));
                    updateCloudStatusBadge();
                    closeLoginModal();
                    
                    // IMPORTANT: Save local data before loading from cloud
                    const localDataBackup = JSON.parse(JSON.stringify(attendanceData));
                    const localDataCount = Object.keys(localDataBackup).length;
                    
                    if (localDataCount > 0) {
                        const migrate = confirm(
                            `üíæ ‚Üí ‚òÅÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è –∫—ä–º –æ–±–ª–∞–∫\n\n` +
                            `–ù–∞–º–µ—Ä–µ–Ω–∏ ${localDataCount} –ª–æ–∫–∞–ª–Ω–∏ –∑–∞–ø–∏—Å–∞.\n\n` +
                            `–ò—Å–∫–∞—à –ª–∏ –¥–∞ –≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—à —Å –æ–±–ª–∞–∫–∞?\n\n` +
                            `OK = –î–∞, –∫–∞—á–∏ –≥–∏\n` +
                            `Cancel = –ù–µ, –∏–∑–ø–æ–ª–∑–≤–∞–π —Å–∞–º–æ –æ–±–ª–∞—á–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏`
                        );
                        
                        if (migrate) {
                            // Upload local data to cloud
                            console.log(`[MIGRATION START] Uploading ${localDataCount} records...`);
                            
                            // Create array of promises
                            const savePromises = Object.keys(localDataBackup).map(date => {
                                const type = localDataBackup[date];
                                console.log(`[MIGRATION] ${date} = ${type}`);
                                return saveToCloud(date, type);
                            });
                            
                            // Wait for ALL saves to complete
                            Promise.all(savePromises)
                                .then(() => {
                                    console.log('[MIGRATION] All saves completed!');
                                    // Mark as migrated
                                    localStorage.setItem('hasLoadedCloudData_' + cloudUser.email, 'true');
                                    
                                    // Wait extra 3 seconds for Google Sheets to process
                                    setTimeout(() => {
                                        console.log('[MIGRATION] Loading from cloud...');
                                        loadCloudData();
                                        alert(`‚úÖ ${localDataCount} –∑–∞–ø–∏—Å–∞ —Å–∞ –∫–∞—á–µ–Ω–∏ –≤ –æ–±–ª–∞–∫–∞!`);
                                    }, 3000);
                                })
                                .catch(error => {
                                    console.error('[MIGRATION ERROR]', error);
                                    alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏! –û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ.');
                                });
                        } else {
                            // Mark as migrated (user chose not to migrate)
                            localStorage.setItem('hasLoadedCloudData_' + cloudUser.email, 'true');
                            
                            // Clear local and use only cloud data
                            attendanceData = {};
                            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                            loadCloudData();
                        }
                    } else {
                        // No local data, just load from cloud
                        localStorage.setItem('hasLoadedCloudData_' + cloudUser.email, 'true');
                        loadCloudData();
                    }
                    
                    openCloudModal();
                    updateCloudModalView();
                    alert('‚úÖ –£—Å–ø–µ—à–µ–Ω –≤—Ö–æ–¥!');
                } else {
                    alert('‚ùå ' + (result.error || '–ì—Ä–µ—à–µ–Ω email –∏–ª–∏ –ø–∞—Ä–æ–ª–∞!'));
                }
            };
            
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.id = callbackName + '_script';
            script.src = url;
            script.onerror = function() {
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å —Å—ä—Ä–≤—ä—Ä–∞!');
                document.getElementById(callbackName + '_script').remove();
                delete window[callbackName];
            };
            document.body.appendChild(script);
        }

        function doRegister() {
            const name = document.getElementById('registerNameInput').value.trim();
            const email = document.getElementById('registerEmailInput').value.trim();
            const password = document.getElementById('registerPasswordInput').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirmInput').value;
            
            if (!email || !password) {
                alert('‚ùå –ú–æ–ª—è –ø–æ–ø—ä–ª–Ω–µ—Ç–µ email –∏ –ø–∞—Ä–æ–ª–∞!');
                return;
            }
            
            if (password !== passwordConfirm) {
                alert('‚ùå –ü–∞—Ä–æ–ª–∏—Ç–µ –Ω–µ —Å—ä–≤–ø–∞–¥–∞—Ç!');
                return;
            }
            
            if (password.length < 6) {
                alert('‚ùå –ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 6 —Å–∏–º–≤–æ–ª–∞!');
                return;
            }
            
            // Use JSONP to get real response
            const callbackName = 'registerCallback_' + Date.now();
            
            window[callbackName] = function(result) {
                document.getElementById(callbackName + '_script').remove();
                delete window[callbackName];
                
                if (result.success) {
                    closeRegisterModal();
                    alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞! –ú–æ–∂–µ—à –¥–∞ –≤–ª–µ–∑–µ—à.');
                    showCloudLogin();
                } else {
                    alert('‚ùå ' + (result.error || '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!'));
                }
            };
            
            const url = `${GOOGLE_APPS_SCRIPT_URL}?action=register&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&name=${encodeURIComponent(name)}&callback=${callbackName}`;
            const script = document.createElement('script');
            script.id = callbackName + '_script';
            script.src = url;
            script.onerror = function() {
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å —Å—ä—Ä–≤—ä—Ä–∞!');
                document.getElementById(callbackName + '_script').remove();
                delete window[callbackName];
            };
            document.body.appendChild(script);
        }

        function cloudLogout() {
            if (confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏ —á–µ –∏—Å–∫–∞—à –¥–∞ –∏–∑–ª–µ–∑–µ—à?')) {
                cloudUser = null;
                localStorage.removeItem('cloudUser');
                updateCloudStatusBadge();
                closeCloudModal();
            }
        }

        // ============================================
        // CLOUD SENDING
        // ============================================
        function sendToMyEmail() {
            if (!cloudUser) return;
            
            const report = generateReport('full');
            
            // Send via Google Apps Script
            fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'sendReport',
                    email: cloudUser.email,
                    reportHTML: report.replace(/\n/g, '<br>'),
                    toEmails: [cloudUser.email]
                })
            })
            .then(() => {
                alert(`‚úÖ –û—Ç—á–µ—Ç—ä—Ç –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –Ω–∞ ${cloudUser.email}`);
            })
            .catch(error => {
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: ' + error.message);
            });
        }

        function showSendToOthers() {
            document.getElementById('cloudLoggedIn').classList.add('hidden');
            document.getElementById('sendToOthersForm').classList.remove('hidden');
        }

        function backToCloudMain() {
            document.getElementById('sendToOthersForm').classList.add('hidden');
            document.getElementById('cloudLoggedIn').classList.remove('hidden');
        }

        function sendToOtherEmails() {
            const emails = document.getElementById('otherEmails').value;
            
            if (!emails.trim()) {
                alert('‚ùå –ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω email –∞–¥—Ä–µ—Å!');
                return;
            }
            
            const emailList = emails.split(',').map(e => e.trim()).filter(e => e);
            
            if (emailList.length === 0) {
                alert('‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω–∏ email –∞–¥—Ä–µ—Å–∏!');
                return;
            }
            
            const report = generateReport('full');
            
            // Send via Google Apps Script
            fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'sendReport',
                    email: cloudUser.email,
                    reportHTML: report.replace(/\n/g, '<br>'),
                    toEmails: emailList
                })
            })
            .then(() => {
                alert(`‚úÖ –û—Ç—á–µ—Ç—ä—Ç –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω –¥–æ:\n\n${emailList.join('\n')}`);
                backToCloudMain();
            })
            .catch(error => {
                alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ: ' + error.message);
            });
        }

        function setManagerEmail() {
            const email = prompt('üìß –í—ä–≤–µ–¥–∏ email –Ω–∞ –º–µ–Ω–∏–¥–∂—ä—Ä:', cloudUser.managerEmail || '');
            
            if (email) {
                cloudUser.managerEmail = email;
                localStorage.setItem('cloudUser', JSON.stringify(cloudUser));
                document.getElementById('managerEmail').textContent = email;
                
                // Update in Google Sheets
                fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        email: cloudUser.email,
                        managerEmail: email
                    })
                });
                
                alert('‚úÖ Email –Ω–∞ –º–µ–Ω–∏–¥–∂—ä—Ä –µ –∑–∞–ø–∞–∑–µ–Ω!');
            }
        }

        function toggleAutoSend(type) {
            if (!cloudUser) return;
            
            if (type === 'me') {
                cloudUser.autoSendToMe = document.getElementById('autoSendToMe').checked;
                localStorage.setItem('cloudUser', JSON.stringify(cloudUser));
                
                // Update in Google Sheets
                fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        email: cloudUser.email,
                        autoSendToMe: cloudUser.autoSendToMe
                    })
                });
                
                if (cloudUser.autoSendToMe) {
                    alert('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –≤–∫–ª—é—á–µ–Ω–æ!\n\n–©–µ –ø–æ–ª—É—á–∞–≤–∞—à –æ—Ç—á–µ—Ç –Ω–∞ –≤—Å–µ–∫–∏ 4 –¥–Ω–∏ –Ω–∞ ' + cloudUser.email);
                } else {
                    alert('‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –∏–∑–∫–ª—é—á–µ–Ω–æ.');
                }
            } else if (type === 'manager') {
                if (!cloudUser.managerEmail) {
                    alert('‚ùå –ü—ä—Ä–≤–æ –∑–∞–¥–∞–π email –Ω–∞ –º–µ–Ω–∏–¥–∂—ä—Ä!');
                    document.getElementById('autoSendToManager').checked = false;
                    return;
                }
                
                cloudUser.autoSendToManager = document.getElementById('autoSendToManager').checked;
                localStorage.setItem('cloudUser', JSON.stringify(cloudUser));
                
                // Update in Google Sheets
                fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateSettings',
                        email: cloudUser.email,
                        autoSendToManager: cloudUser.autoSendToManager
                    })
                });
                
                if (cloudUser.autoSendToManager) {
                    alert('‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –≤–∫–ª—é—á–µ–Ω–æ!\n\n–ú–µ–Ω–∏–¥–∂—ä—Ä—ä—Ç —â–µ –ø–æ–ª—É—á–∞–≤–∞ –æ—Ç—á–µ—Ç –Ω–∞ –≤—Å–µ–∫–∏ 4 –¥–Ω–∏ –Ω–∞ ' + cloudUser.managerEmail);
                } else {
                    alert('‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º –º–µ–Ω–∏–¥–∂—ä—Ä –∏–∑–∫–ª—é—á–µ–Ω–æ.');
                }
            }
        }

        // ============================================
        // ORIGINAL APP CODE CONTINUES BELOW
        // ============================================

        function addDay(type) {
            const dateInput = document.getElementById('dateInput').value;
            if (!dateInput) {
                alert('–ú–æ–ª—è –∏–∑–±–µ—Ä–∏ –¥–∞—Ç–∞!');
                return;
            }

            // Parse date in local timezone
            const parts = dateInput.split('-');
            const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            date.setHours(0, 0, 0, 0);
            const dayOfWeek = date.getDay();
            
            // Check if weekend
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                if (!confirm('–ò–∑–±—Ä–∞–Ω–∞ –µ –ø–æ—á–∏–≤–µ–Ω –¥–µ–Ω. –°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?')) {
                    return;
                }
            }

            attendanceData[dateInput] = type;
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Save to cloud if logged in
            if (cloudUser && cloudUser.email) {
                saveToCloud(dateInput, type);
            }
            
            updateDisplay();
            
            // Move to next working day
            const nextDate = new Date(date);
            nextDate.setDate(nextDate.getDate() + 1);
            nextDate.setHours(0, 0, 0, 0);
            
            // Skip weekends
            while (nextDate.getDay() === 0 || nextDate.getDay() === 6) {
                nextDate.setDate(nextDate.getDate() + 1);
                nextDate.setHours(0, 0, 0, 0);
            }
            
            document.getElementById('dateInput').valueAsDate = nextDate;
        }

        function changePeriod(period) {
            currentPeriod = period;
            
            // Update button states
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDisplay();
        }

        function updateDisplay() {
            updateStats();
            updateCalendar();
        }

        function getDateRange(period) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let startDate, endDate;

            if (period === 'week') {
                // Current week (Monday to Sunday)
                const dayOfWeek = today.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                startDate = new Date(today);
                startDate.setDate(today.getDate() + diff);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(0, 0, 0, 0);
            } else if (period === 'month') {
                // Current month - full month
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                endDate.setHours(0, 0, 0, 0);
            } else if (period === 'quarter') {
                // Current quarter (Q1: Jan-Mar, Q2: Apr-Jun, Q3: Jul-Sep, Q4: Oct-Dec)
                const currentMonth = today.getMonth();
                const quarterStartMonth = Math.floor(currentMonth / 3) * 3;
                startDate = new Date(today.getFullYear(), quarterStartMonth, 1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(today.getFullYear(), quarterStartMonth + 3, 0);
                endDate.setHours(0, 0, 0, 0);
            }

            return { startDate, endDate };
        }

        function getWorkingDaysInRange(startDate, endDate) {
            let count = 0;
            const current = new Date(startDate);
            
            while (current <= endDate) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    count++;
                }
                current.setDate(current.getDate() + 1);
            }
            
            return count;
        }

        function updateStats() {
            const { startDate, endDate } = getDateRange(currentPeriod);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let officeDays = 0;
            let homeDays = 0;
            let vacationDays = 0;
            let holidayDays = 0;
            let autoHomeDays = 0;
            
            const current = new Date(startDate);
            while (current <= endDate) {
                const year = current.getFullYear();
                const month = String(current.getMonth() + 1).padStart(2, '0');
                const day = String(current.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                const dayOfWeek = current.getDay();
                
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    const recordedType = attendanceData[dateStr];
                    
                    if (recordedType === 'office') {
                        officeDays++;
                    } else if (recordedType === 'home') {
                        homeDays++;
                    } else if (recordedType === 'vacation') {
                        vacationDays++;
                    } else if (recordedType === 'holiday') {
                        holidayDays++;
                    } else if (current < today) {
                        // Past working day with no record = auto home office
                        autoHomeDays++;
                    }
                }
                
                current.setDate(current.getDate() + 1);
            }

            const totalHomeDays = homeDays + autoHomeDays;
            const totalWorkingDays = getWorkingDaysInRange(startDate, endDate);
            const totalRecordedDays = officeDays + totalHomeDays + vacationDays + holidayDays;
            const availableWorkingDays = totalWorkingDays - vacationDays - holidayDays;
            const targetOfficeDays = Math.round(availableWorkingDays * 0.6);
            const compliancePercent = availableWorkingDays > 0 ? (officeDays / availableWorkingDays * 100) : 0;
            const remainingOfficeDays = Math.max(0, targetOfficeDays - officeDays);

            let statusClass, statusText, alertHTML = '';
            
            if (compliancePercent >= 60) {
                statusClass = 'status-good';
                statusText = '‚úÖ –ö–æ–º–ø–ª–∞–π—ä–Ω—Ç';
            } else if (compliancePercent >= 50) {
                statusClass = 'status-warning';
                statusText = '‚ö†Ô∏è –ë–ª–∏–∑–æ –¥–æ —Ü–µ–ª—Ç–∞';
                alertHTML = `<div class="alert alert-warning">–í–Ω–∏–º–∞–Ω–∏–µ! –¢—Ä—è–±–≤–∞—Ç –æ—â–µ ${remainingOfficeDays} –¥–Ω–∏ –≤ –æ—Ñ–∏—Å–∞ –¥–æ –∫—Ä–∞—è –Ω–∞ –ø–µ—Ä–∏–æ–¥–∞.</div>`;
            } else {
                statusClass = 'status-danger';
                statusText = '‚ùå –ü–æ–¥ —Ü–µ–ª—Ç–∞';
                alertHTML = `<div class="alert alert-warning">–í–Ω–∏–º–∞–Ω–∏–µ! –ó–Ω–∞—á–∏—Ç–µ–ª–Ω–æ –∏–∑–æ—Å—Ç–∞–≤–∞–Ω–µ - –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ ${remainingOfficeDays} –æ—Ñ–∏—Å –¥–Ω–∏!</div>`;
            }

            let periodName = currentPeriod === 'week' ? '–°–µ–¥–º–∏—Ü–∞' : 
                           currentPeriod === 'month' ? '–ú–µ—Å–µ—Ü' : 
                           '–¢—Ä–∏–º–µ—Å–µ—á–∏–µ';

            const statsHTML = `
                <div class="stat-card">
                    <h3>üè¢ –î–Ω–∏ –≤ –û—Ñ–∏—Å–∞</h3>
                    <div class="stat-value" style="color: #4CAF50;">${officeDays}</div>
                    <div class="stat-label">–æ—Ç ${availableWorkingDays} —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(officeDays/availableWorkingDays*100) || 0}%; background: #4CAF50;">
                            ${Math.round((officeDays/availableWorkingDays*100) || 0)}%
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <h3>üéØ –ö–æ–º–ø–ª–∞–π—ä–Ω—Å (60% –¶–µ–ª)</h3>
                    <div class="stat-value" style="color: ${compliancePercent >= 60 ? '#4CAF50' : compliancePercent >= 50 ? '#FF9800' : '#f44336'};">
                        ${Math.round(compliancePercent)}%
                    </div>
                    <div class="stat-label">–¶–µ–ª: ${targetOfficeDays} –æ—Ñ–∏—Å –¥–Ω–∏</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(compliancePercent, 100)}%; 
                             background: ${compliancePercent >= 60 ? '#4CAF50' : compliancePercent >= 50 ? '#FF9800' : '#f44336'};">
                            ${Math.round(compliancePercent)}%
                        </div>
                    </div>
                    <div class="status-indicator ${statusClass}">${statusText}</div>
                </div>

                <div class="stat-card">
                    <h3>üìä –û–±–æ–±—â–µ–Ω–∏–µ –∑–∞ ${periodName}</h3>
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span>üè¢ –û—Ñ–∏—Å:</span>
                            <strong style="color: #4CAF50;">${officeDays} –¥–Ω–∏</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span>üè† Home Office:</span>
                            <strong style="color: #2196F3;">${totalHomeDays} –¥–Ω–∏</strong>
                        </div>
                        ${autoHomeDays > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin: 5px 0 10px 20px; font-size: 0.9em; color: #666;">
                            <span>‚Ü≥ –º–∞—Ä–∫–∏—Ä–∞–Ω–∏:</span>
                            <span>${homeDays}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 5px 0 10px 20px; font-size: 0.9em; color: #666;">
                            <span>‚Ü≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏:</span>
                            <span>${autoHomeDays}</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span>üå¥ –ü–æ—á–∏–≤–∫–∞/–ë–æ–ª–Ω–∏—á–µ–Ω:</span>
                            <strong style="color: #FF9800;">${vacationDays} –¥–Ω–∏</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span>üéâ –ü—Ä–∞–∑–Ω–∏—Ü–∏:</span>
                            <strong style="color: #9C27B0;">${holidayDays} –¥–Ω–∏</strong>
                        </div>
                        <hr style="margin: 15px 0; border: none; border-top: 2px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <span><strong>–û—Å—Ç–∞–≤–∞—Ç –æ—Ñ–∏—Å –¥–Ω–∏:</strong></span>
                            <strong style="color: #667eea; font-size: 1.3em;">${remainingOfficeDays}</strong>
                        </div>
                    </div>
                    ${alertHTML}
                </div>
            `;

            document.getElementById('statsGrid').innerHTML = statsHTML;
        }

        function updateCalendar() {
            const { startDate, endDate } = getDateRange(currentPeriod);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const monthNames = ['–Ø–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞–π', '–Æ–Ω–∏', 
                              '–Æ–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];
            
            let title = '';
            if (currentPeriod === 'week') {
                title = `–°–µ–¥–º–∏—Ü–∞: ${startDate.getDate()} ${monthNames[startDate.getMonth()]} - ${endDate.getDate()} ${monthNames[endDate.getMonth()]} ${endDate.getFullYear()}`;
            } else if (currentPeriod === 'month') {
                title = `${monthNames[startDate.getMonth()]} ${startDate.getFullYear()}`;
            } else {
                const quarterNum = Math.floor(startDate.getMonth() / 3) + 1;
                const quarterMonths = [
                    '–Ø–Ω—É–∞—Ä–∏ - –ú–∞—Ä—Ç',
                    '–ê–ø—Ä–∏–ª - –Æ–Ω–∏',
                    '–Æ–ª–∏ - –°–µ–ø—Ç–µ–º–≤—Ä–∏',
                    '–û–∫—Ç–æ–º–≤—Ä–∏ - –î–µ–∫–µ–º–≤—Ä–∏'
                ];
                title = `Q${quarterNum} ${startDate.getFullYear()} (${quarterMonths[quarterNum - 1]})`;
            }
            
            document.getElementById('calendarTitle').textContent = title;

            let calendarHTML = '';
            const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
            
            // Add day headers
            dayNames.forEach(day => {
                calendarHTML += `<div class="day-header">${day}</div>`;
            });

            // Find the first Monday
            const firstDay = new Date(startDate);
            firstDay.setHours(0, 0, 0, 0);
            const dayOfWeek = firstDay.getDay();
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            firstDay.setDate(firstDay.getDate() + diff);
            firstDay.setHours(0, 0, 0, 0);

            // Generate calendar days
            const current = new Date(firstDay);
            current.setHours(0, 0, 0, 0);
            const lastDay = new Date(endDate);
            lastDay.setHours(0, 0, 0, 0);
            
            // Extend to end of week
            while (lastDay.getDay() !== 0) {
                lastDay.setDate(lastDay.getDate() + 1);
            }
            lastDay.setHours(0, 0, 0, 0);

            // Store actual calendar range for opacity calculation
            const calendarStart = new Date(firstDay);
            const calendarEnd = new Date(lastDay);

            while (current <= lastDay) {
                // Use local date formatting instead of toISOString to avoid timezone issues
                const year = current.getFullYear();
                const month = String(current.getMonth() + 1).padStart(2, '0');
                const day = String(current.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                
                const dayOfWeek = current.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const dayType = attendanceData[dateStr] || '';
                const isPast = current < today;
                
                let className = 'calendar-day';
                let emoji = '';
                
                if (isWeekend) {
                    className += ' day-weekend';
                } else if (dayType === 'office') {
                    className += ' day-office';
                    emoji = 'üè¢';
                } else if (dayType === 'home') {
                    className += ' day-home';
                    emoji = 'üè†';
                } else if (dayType === 'vacation') {
                    className += ' day-vacation';
                    emoji = 'üå¥';
                } else if (dayType === 'holiday') {
                    className += ' day-holiday';
                    emoji = 'üéâ';
                } else if (isPast) {
                    // Past working day with no record = auto home office
                    className += ' day-home-auto';
                    emoji = 'üì±';
                }

                // Use period boundaries for opacity (startDate/endDate), not calendar boundaries
                const isInRange = current >= startDate && current <= endDate;
                const opacity = isInRange ? '1' : '0.3';

                calendarHTML += `
                    <div class="${className}" style="opacity: ${opacity}" 
                         onclick="selectDate('${dateStr}')" 
                         title="${dateStr}">
                        <div class="day-number">${current.getDate()}</div>
                        <div>${emoji}</div>
                    </div>
                `;

                current.setDate(current.getDate() + 1);
                current.setHours(0, 0, 0, 0);
            }

            document.getElementById('calendarGrid').innerHTML = calendarHTML;
        }

        function selectDate(dateStr) {
            document.getElementById('dateInput').value = dateStr;
        }

        // Initial display
        updateDisplay();

        function openInfoModal() {
            document.getElementById('infoModal').style.display = 'block';
        }

        function closeInfoModal() {
            document.getElementById('infoModal').style.display = 'none';
        }

        function openDataModal() {
            document.getElementById('dataModal').style.display = 'block';
        }

        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        function openShareModal() {
            document.getElementById('shareModal').style.display = 'block';
        }

        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        // Generate report text
        function generateReport(format = 'full') {
            const monthNames = ['–Ø–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞–π', '–Æ–Ω–∏', 
                              '–Æ–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];
            
            const today = new Date();
            const dateStr = `${today.getDate()} ${monthNames[today.getMonth()]} ${today.getFullYear()}`;
            
            // Calculate stats for all three periods
            const periods = ['week', 'month', 'quarter'];
            const stats = {};
            
            periods.forEach(period => {
                const { startDate, endDate } = getDateRange(period);
                const todayNorm = new Date();
                todayNorm.setHours(0, 0, 0, 0);
                
                let officeDays = 0, homeDays = 0, vacationDays = 0, holidayDays = 0, autoHomeDays = 0;
                
                const current = new Date(startDate);
                while (current <= endDate) {
                    const year = current.getFullYear();
                    const month = String(current.getMonth() + 1).padStart(2, '0');
                    const day = String(current.getDate()).padStart(2, '0');
                    const dStr = `${year}-${month}-${day}`;
                    
                    const dayOfWeek = current.getDay();
                    
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        const recordedType = attendanceData[dStr];
                        if (recordedType === 'office') officeDays++;
                        else if (recordedType === 'home') homeDays++;
                        else if (recordedType === 'vacation') vacationDays++;
                        else if (recordedType === 'holiday') holidayDays++;
                        else if (current < todayNorm) autoHomeDays++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                
                const totalHomeDays = homeDays + autoHomeDays;
                const totalWorkingDays = getWorkingDaysInRange(startDate, endDate);
                const availableWorkingDays = totalWorkingDays - vacationDays - holidayDays;
                const targetOfficeDays = Math.round(availableWorkingDays * 0.6);
                const compliancePercent = availableWorkingDays > 0 ? (officeDays / availableWorkingDays * 100) : 0;
                const remainingOfficeDays = Math.max(0, targetOfficeDays - officeDays);
                
                let periodLabel = '';
                if (period === 'week') {
                    periodLabel = `${startDate.getDate()} ${monthNames[startDate.getMonth()].substring(0,3)} - ${endDate.getDate()} ${monthNames[endDate.getMonth()].substring(0,3)}`;
                } else if (period === 'month') {
                    periodLabel = monthNames[startDate.getMonth()] + ' ' + startDate.getFullYear();
                } else {
                    const quarterNum = Math.floor(startDate.getMonth() / 3) + 1;
                    periodLabel = `Q${quarterNum} ${startDate.getFullYear()}`;
                }
                
                stats[period] = {
                    label: periodLabel,
                    officeDays,
                    totalHomeDays,
                    vacationDays,
                    holidayDays,
                    compliancePercent,
                    remainingOfficeDays
                };
            });
            
            // Generate report based on format
            if (format === 'full') {
                // Full Telegram format
                return `üìä –û–§–ò–° –¢–†–ê–ö–ï–† - –û–¢–ß–ï–¢
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìÖ –î–∞—Ç–∞: ${dateStr}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç –°–ï–î–ú–ò–ß–ù–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê
(${stats.week.label})

üè¢ –û—Ñ–∏—Å: ${stats.week.officeDays} –¥–Ω–∏
üè† Home Office: ${stats.week.totalHomeDays} –¥–Ω–∏
üéØ –ö–æ–º–ø–ª–∞–π—ä–Ω—Å: ${Math.round(stats.week.compliancePercent)}% ${stats.week.compliancePercent >= 60 ? '‚úÖ' : '‚ö†Ô∏è'}
‚ö° –û—Å—Ç–∞–≤–∞—Ç: ${stats.week.remainingOfficeDays === 0 ? '0 –¥–Ω–∏ (—Ü–µ–ª –ø–æ—Å—Ç–∏–≥–Ω–∞—Ç–∞!)' : '–æ—â–µ ' + stats.week.remainingOfficeDays + ' –æ—Ñ–∏—Å –¥–Ω–∏'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç –ú–ï–°–ï–ß–ù–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê
(${stats.month.label})

üè¢ –û—Ñ–∏—Å: ${stats.month.officeDays} –¥–Ω–∏
üè† Home Office: ${stats.month.totalHomeDays} –¥–Ω–∏
üå¥ –ü–æ—á–∏–≤–∫–∞: ${stats.month.vacationDays} ${stats.month.vacationDays === 1 ? '–¥–µ–Ω' : '–¥–Ω–∏'}
üéØ –ö–æ–º–ø–ª–∞–π—ä–Ω—Å: ${Math.round(stats.month.compliancePercent)}% ${stats.month.compliancePercent >= 60 ? '‚úÖ' : '‚ö†Ô∏è'}
‚ö° –û—Å—Ç–∞–≤–∞—Ç: ${stats.month.remainingOfficeDays === 0 ? '0 –¥–Ω–∏ (—Ü–µ–ª –ø–æ—Å—Ç–∏–≥–Ω–∞—Ç–∞!)' : '–æ—â–µ ' + stats.month.remainingOfficeDays + ' –æ—Ñ–∏—Å –¥–Ω–∏'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç –¢–†–ò–ú–ï–°–ï–ß–ù–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê
(${stats.quarter.label})

üè¢ –û—Ñ–∏—Å: ${stats.quarter.officeDays} –¥–Ω–∏
üè† Home Office: ${stats.quarter.totalHomeDays} –¥–Ω–∏
üå¥ –ü–æ—á–∏–≤–∫–∞: ${stats.quarter.vacationDays} ${stats.quarter.vacationDays === 1 ? '–¥–µ–Ω' : '–¥–Ω–∏'}
üéâ –ü—Ä–∞–∑–Ω–∏—Ü–∏: ${stats.quarter.holidayDays} ${stats.quarter.holidayDays === 1 ? '–¥–µ–Ω' : '–¥–Ω–∏'}
üéØ –ö–æ–º–ø–ª–∞–π—ä–Ω—Å: ${Math.round(stats.quarter.compliancePercent)}% ${stats.quarter.compliancePercent >= 60 ? '‚úÖ' : '‚ö†Ô∏è'}
‚ö° –û—Å—Ç–∞–≤–∞—Ç: ${stats.quarter.remainingOfficeDays === 0 ? '0 –¥–Ω–∏ (–∫–æ–º–ø–ª–∞–π—ä–Ω—Ç!)' : '–æ—â–µ ' + stats.quarter.remainingOfficeDays + ' –æ—Ñ–∏—Å –¥–Ω–∏'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–æ –æ—Ç: –û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä 3x2
by Bozhidar Stoykov`;
            } else {
                // Ultra compact email format
                const todayShort = `${today.getDate()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getFullYear()).substring(2)}`;
                
                return `üìä –û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä ${todayShort}

–°–ï–î–ú–ò–¶–ê: ${Math.round(stats.week.compliancePercent)}% ${stats.week.compliancePercent >= 60 ? '‚úÖ' : '‚ö†Ô∏è'}
–û—Ñ–∏—Å ${stats.week.officeDays}–¥, Home ${stats.week.totalHomeDays}–¥ ‚Üí –û—Å—Ç–∞–≤–∞—Ç ${stats.week.remainingOfficeDays}–¥

–ú–ï–°–ï–¶: ${Math.round(stats.month.compliancePercent)}% ${stats.month.compliancePercent >= 60 ? '‚úÖ' : '‚ö†Ô∏è'}
–û—Ñ–∏—Å ${stats.month.officeDays}–¥, Home ${stats.month.totalHomeDays}–¥, –ü–æ—á–∏–≤–∫–∞ ${stats.month.vacationDays}–¥ ‚Üí –û—Å—Ç–∞–≤–∞—Ç ${stats.month.remainingOfficeDays}–¥

Q1: ${Math.round(stats.quarter.compliancePercent)}% ${stats.quarter.compliancePercent >= 60 ? '‚úÖ' : '‚ö†Ô∏è'}
–û—Ñ–∏—Å ${stats.quarter.officeDays}–¥, Home ${stats.quarter.totalHomeDays}–¥, –ü–æ—á–∏–≤–∫–∞ ${stats.quarter.vacationDays}–¥ ‚Üí –û—Å—Ç–∞–≤–∞—Ç ${stats.quarter.remainingOfficeDays}–¥

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä 3x2 by Bozhidar Stoykov`;
            }
        }

        // Share via email
        function shareViaEmail() {
            const report = generateReport('full');  // Changed from 'compact' to 'full'
            const subject = encodeURIComponent('–û—Ñ–∏—Å –¢—Ä–∞–∫–µ—Ä - –û—Ç—á–µ—Ç ' + new Date().toISOString().split('T')[0]);
            const body = encodeURIComponent(report);
            window.open(`mailto:?subject=${subject}&body=${body}`, '_self');
            closeShareModal();
        }

        // Share via Telegram
        function shareViaTelegram() {
            const report = generateReport('full');
            const text = encodeURIComponent(report);
            window.open(`https://t.me/share/url?text=${text}`, '_blank');
            closeShareModal();
        }

        // Copy report to clipboard
        function copyReport() {
            const report = generateReport('full');
            navigator.clipboard.writeText(report).then(() => {
                alert('‚úÖ –û—Ç—á–µ—Ç—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω –≤ clipboard!');
                closeShareModal();
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = report;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ –û—Ç—á–µ—Ç—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω –≤ clipboard!');
                closeShareModal();
            });
        }

        // Export data as JSON
        function exportJSON() {
            const dataStr = JSON.stringify(attendanceData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const today = new Date().toISOString().split('T')[0];
            const filename = `office-tracker-backup-${today}.json`;
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–∑—Ç–µ–≥–ª–µ–Ω–∏ –∫–∞—Ç–æ ${filename}`);
        }

        // Export data as CSV
        function exportCSV() {
            let csv = '–î–∞—Ç–∞,–¢–∏–ø\n';
            
            const sortedDates = Object.keys(attendanceData).sort();
            sortedDates.forEach(date => {
                const typeMap = {
                    'office': '–û—Ñ–∏—Å',
                    'home': 'Home Office',
                    'vacation': '–ü–æ—á–∏–≤–∫–∞/–ë–æ–ª–Ω–∏—á–µ–Ω',
                    'holiday': '–ü—Ä–∞–∑–Ω–∏–∫'
                };
                const type = typeMap[attendanceData[date]] || attendanceData[date];
                csv += `${date},${type}\n`;
            });
            
            const dataBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            
            const today = new Date().toISOString().split('T')[0];
            const filename = `office-tracker-${today}.csv`;
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–∑—Ç–µ–≥–ª–µ–Ω–∏ –∫–∞—Ç–æ ${filename}`);
        }

        // Import data from JSON
        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Count existing and new records
                    const existingCount = Object.keys(attendanceData).length;
                    const importCount = Object.keys(importedData).length;
                    
                    if (existingCount > 0) {
                        const merge = confirm(
                            `–ù–∞–º–µ—Ä–µ–Ω–∏ —Å–∞ ${existingCount} —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ –∑–∞–ø–∏—Å–∞.\n\n` +
                            `–ò–º–ø–æ—Ä—Ç–∏—Ä–∞—à ${importCount} –∑–∞–ø–∏—Å–∞ –æ—Ç —Ñ–∞–π–ª–∞.\n\n` +
                            `–ù–∞—Ç–∏—Å–Ω–∏ OK –∑–∞ –î–û–ë–ê–í–Ø–ù–ï (merge)\n` +
                            `–ù–∞—Ç–∏—Å–Ω–∏ Cancel –∑–∞ –ü–†–ï–ó–ê–ü–ò–°–í–ê–ù–ï (replace)`
                        );
                        
                        if (!merge) {
                            // Replace all data
                            attendanceData = importedData;
                        } else {
                            // Merge data (imported data overwrites conflicts)
                            attendanceData = { ...attendanceData, ...importedData };
                        }
                    } else {
                        // No existing data, just import
                        attendanceData = importedData;
                    }
                    
                    localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    updateDisplay();
                    closeDataModal();
                    
                    alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ ${importCount} –∑–∞–ø–∏—Å–∞!`);
                } catch (error) {
                    alert('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–µ—Ç–µ–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞! –ú–æ–ª—è –∏–∑–ø–æ–ª–∑–≤–∞–π –≤–∞–ª–∏–¥–µ–Ω JSON —Ñ–∞–π–ª.');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            
            // Reset input so same file can be selected again
            event.target.value = '';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const infoModal = document.getElementById('infoModal');
            const localModal = document.getElementById('localModal');
            const cloudModal = document.getElementById('cloudModal');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            
            if (event.target == infoModal) {
                closeInfoModal();
            } else if (event.target == localModal) {
                closeLocalModal();
            } else if (event.target == cloudModal) {
                closeCloudModal();
            } else if (event.target == loginModal) {
                closeLoginModal();
            } else if (event.target == registerModal) {
                closeRegisterModal();
            }
        }
    </script>
</body>
</html>
